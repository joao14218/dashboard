<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alunos - Arena Louzada</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root{--primary-color:#ffc400;--primary-hover-color:#e6b000;--dark-bg:#1a1a1a;--dark-card:#2c2c2c;--text-light:#f0f0f0;--text-muted:#a0a0a0;--border-color:#444;--success-color:#28a745;--danger-color:#e74c3c;--warning-color:#ffc400;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{display:flex;background-color:var(--dark-bg);color:var(--text-light)}
        .app-layout{display:flex;width:100%;min-height:100vh}
        .sidebar{width:240px;background-color:var(--dark-card);padding:20px;display:flex;flex-direction:column;border-right:1px solid var(--border-color)}
        .sidebar-header{text-align:center;margin-bottom:40px}.sidebar-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);margin-bottom:10px}
        .sidebar-header h2{font-size:1.2rem;color:var(--text-light)}
        .nav-menu{flex-grow:1}.nav-menu a{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:8px;text-decoration:none;color:var(--text-muted);font-weight:600;transition:background-color .3s,color .3s}.nav-menu a i{font-size:1.5rem;margin-right:15px}.nav-menu a.active,.nav-menu a:hover{background-color:var(--primary-color);color:#000}

        .main-content{flex-grow:1;padding:40px;overflow-y:auto}
        .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:30px}
        .tab-button{padding:15px 30px;cursor:pointer;background:none;border:none;color:var(--text-muted);font-size:1rem;font-weight:600}
        .tab-button.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
        .tab-content{display:none}.tab-content.active{display:block}
        
        .student-table-wrapper{overflow-x:auto; background-color: var(--dark-card); padding:20px; border-radius: 10px;}
        .student-table{width:100%;border-collapse:collapse; text-align:left;}
        .student-table th, .student-table td{padding:15px;border-bottom:1px solid var(--border-color)}
        .student-table th{font-size:0.9rem;text-transform:uppercase;color:var(--text-muted)}
        .student-table img{width:40px;height:40px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:10px}
        .student-table tbody tr {cursor: pointer; transition: background 0.2s;} .student-table tbody tr:hover{background: #333;}
        
        .status-tag{padding:5px 12px;border-radius:15px;font-weight:bold;font-size:.9rem;color:#fff}
        .status-em-dia{background-color:var(--success-color)}
        .status-vencendo{background-color:var(--warning-color); color: #000;}
        .status-vencido{background-color:var(--danger-color)}

        /* Form Cadastro Styles */
        .form-card{background-color:var(--dark-card);padding:30px;border-radius:10px;max-width:800px;margin:auto}
        .registration-form-layout{display:flex;gap:40px;align-items:flex-start}
        @media (max-width: 768px) { .registration-form-layout { flex-direction: column; align-items: center; } }
        .photo-uploader{flex-shrink:0;width:180px;text-align:center;position:relative}.photo-uploader label{display:block;width:180px;height:180px;border:2px dashed var(--border-color);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#888;overflow:hidden}.photo-uploader .upload-icon{font-size:3rem}#photo-preview img{width:100%;height:100%;object-fit:cover}
        .form-fields{flex-grow:1; width:100%;}.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}.form-group.full-width{grid-column:1/-1}
        .form-group{margin-bottom:15px}
        .form-group label{display:block; margin-bottom:8px; font-weight:600;}
        .form-group input,.form-group select{width:100%;padding:12px;border-radius:8px;background-color:#3a3a3a;border:1px solid var(--border-color);color:var(--text-light);font-size:1rem}
        .submit-button{width:100%;padding:15px;border:none;border-radius:8px;background-color:var(--primary-color);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer}
        .delete-btn{background-color:var(--danger-color);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:5px;}
        .hidden{display:none}

        /* Modal Styles */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal-content{background-color:var(--dark-card);padding:30px;border-radius:10px;width:100%;max-width:600px;position: relative; max-height: 90vh; overflow-y: auto;}
        .close-modal-btn{position:absolute;top:15px;right:15px;background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;}
        .modal-header{text-align:center; margin-bottom:20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        .modal-header img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-color);margin-bottom:10px}
        
        .detail-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #3a3a3a;align-items:center}.detail-item strong{color:var(--text-muted)}
        .detail-item input, .detail-item select{background-color:#4f4f4f;border:1px solid #666;text-align:right; color: var(--text-light); padding: 5px; border-radius: 5px;}
        
        /* Payment Section */
        .payment-section{background-color:#333; padding: 15px; border-radius: 8px; margin-top: 20px;}
        .payment-options{display:flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;}
        .pay-btn{flex: 1 1 45%; padding: 12px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: filter 0.2s;}
        .pay-btn:hover{filter: brightness(1.1);}
        
        .pay-manual{background-color: var(--success-color); color: white;}
        .pay-online{background-color: #0099ff; color: white;}
        .pay-credit{background-color: #e67e22; color: white;}
        .pay-debit{background-color: #9b59b6; color: white;}
        
        .qr-display{text-align: center; margin-top: 15px; display: none;}
        .qr-display img{width: 200px; height: 200px; background: white; padding: 10px; border-radius: 8px;}

        .btn-edit{background-color:var(--primary-color);color:#000; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer;}
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="tabs" id="tabs-container">
                <button class="tab-button active" onclick="openTab(event, 'Listar')">Listar Alunos</button>
                <button class="tab-button" onclick="openTab(event, 'Cadastrar')">Cadastrar Aluno</button>
                <button class="tab-button" onclick="openTab(event, 'Grade')">Grade de Aulas</button>
            </div>
            
            <div id="Listar" class="tab-content active">
                <h2 id="lista-alunos-titulo">Lista de Alunos</h2>
                <div class="student-table-wrapper">
                    <table class="student-table">
                        <thead><tr><th>Aluno</th><th>Plano</th><th>Turma/Horário</th><th>Vencimento</th><th>Status</th></tr></thead>
                        <tbody id="student-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="Cadastrar" class="tab-content">
                <div class="form-card">
                    <h1 style="margin-bottom: 5px;">Cadastro de Novo Aluno</h1>
                    <p style="color: var(--text-muted); margin-bottom: 25px;">Preencha os dados e adicione uma foto para o perfil.</p>
                    
                    <form id="registrationForm">
                        <div class="registration-form-layout">
                            <div class="photo-uploader">
                                <label for="photo-input">
                                    <div id="photo-preview"><span class="upload-icon"><i class="ph ph-camera-plus"></i></span><br><span>Enviar Foto</span></div>
                                </label>
                                <input type="file" id="photo-input" accept="image/*" class="hidden">
                            </div>
                            
                            <div class="form-fields">
                                <div class="form-grid">
                                    <div class="form-group full-width">
                                        <label for="nome">Nome Completo</label>
                                        <input type="text" id="nome" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cpf">CPF</label>
                                        <input type="text" id="cpf" placeholder="000.000.000-00" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="nascimento">Data de Nascimento</label>
                                        <input type="date" id="nascimento" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="celular">Celular (WhatsApp)</label>
                                        <input type="tel" id="celular" placeholder="(00) 00000-0000" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input type="email" id="email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="plano">Plano Escolhido</label>
                                        <select id="plano" required>
                                            <option value="" disabled selected>Carregando planos...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="inicio">Data de Início</label>
                                        <input type="date" id="inicio" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label for="grade-horario-cadastro">Turma / Horário (Crie na aba 'Grade de Aulas')</label>
                                        <select id="grade-horario-cadastro" required>
                                            <option value="" disabled selected>Carregando horários...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top:20px;">
                            <button type="submit" class="submit-button">Cadastrar Aluno</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="Grade" class="tab-content">
                <div class="form-card" style="max-width: 100%;">
                    <h2 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Gerenciar Grade de Horários</h2>
                    
                    <form id="form-horario" style="display: flex; gap: 15px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Dia da Semana</label>
                            <select id="dia-semana" required>
                                <option value="Segunda">Segunda-feira</option>
                                <option value="Terça">Terça-feira</option>
                                <option value="Quarta">Quarta-feira</option>
                                <option value="Quinta">Quinta-feira</option>
                                <option value="Sexta">Sexta-feira</option>
                                <option value="Sábado">Sábado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                            <label>Horário</label>
                            <input type="time" id="hora-inicio" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Professor</label>
                            <input type="text" id="nome-professor" placeholder="Ex: Prof. João" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Nível</label>
                            <input type="text" id="nivel-turma" placeholder="Ex: Iniciante">
                        </div>
                        <button type="submit" class="submit-button" style="width: auto; padding: 12px 20px;">Adicionar Turma</button>
                    </form>

                    <div class="student-table-wrapper">
                        <table class="student-table">
                            <thead><tr><th>Dia</th><th>Horário</th><th>Professor</th><th>Nível</th><th>Ação</th></tr></thead>
                            <tbody id="lista-horarios-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="student-details-modal">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            
            updateAllStudentStatuses();
            loadStudentList();
            loadGradeTable();   
            loadGradeOptions(); 
            loadPlanOptions(); // NOVA FUNÇÃO: Carrega os planos de Configurações
            
            window.openTab = function(evt, tabName) {
                document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
                document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.classList.add("active");
            }

            document.body.addEventListener('click', (e) => {
                if(e.target.closest('.close-modal-btn') || e.target.classList.contains('modal-overlay')) {
                     document.getElementById('student-details-modal').classList.remove('active');
                }
                
                const studentRow = e.target.closest('#student-list-body tr');
                if(studentRow) {
                    showStudentDetailsModal(studentRow.dataset.matricula);
                }

                if(e.target.closest('.delete-grade-btn')) {
                    const index = e.target.closest('.delete-grade-btn').dataset.index;
                    const grade = JSON.parse(localStorage.getItem('gradeHorarios')) || [];
                    grade.splice(index, 1);
                    localStorage.setItem('gradeHorarios', JSON.stringify(grade));
                    loadGradeTable();
                    loadGradeOptions(); 
                }
            });

            // --- CARREGAR PLANOS (NOVIDADE) ---
            function loadPlanOptions() {
                const planosConfig = JSON.parse(localStorage.getItem('arenaPlanos')) || [];
                const selectPlano = document.getElementById('plano');
                
                if (planosConfig.length === 0) {
                    selectPlano.innerHTML = '<option value="" disabled selected>Nenhum plano criado. Vá em Configurações.</option>';
                    return;
                }

                selectPlano.innerHTML = '<option value="" disabled selected>Selecione um plano</option>';
                planosConfig.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome;
                    option.textContent = `${p.nome} (R$ ${parseFloat(p.valor).toFixed(2).replace('.', ',')})`;
                    selectPlano.appendChild(option);
                });
            }

            // --- GERENCIAMENTO DA GRADE DE AULAS ---
            document.getElementById('form-horario').addEventListener('submit', (e) => {
                e.preventDefault();
                const novoHorario = {
                    dia: document.getElementById('dia-semana').value,
                    hora: document.getElementById('hora-inicio').value,
                    professor: document.getElementById('nome-professor').value,
                    nivel: document.getElementById('nivel-turma').value || 'Geral'
                };

                const grade = JSON.parse(localStorage.getItem('gradeHorarios')) || [];
                grade.push(novoHorario);
                localStorage.setItem('gradeHorarios', JSON.stringify(grade));
                
                e.target.reset();
                loadGradeTable();
                loadGradeOptions(); 
            });

            function loadGradeTable() {
                const grade = JSON.parse(localStorage.getItem('gradeHorarios')) || [];
                const tbody = document.getElementById('lista-horarios-body');
                
                grade.sort((a,b) => (a.dia > b.dia) ? 1 : -1); 
                
                tbody.innerHTML = '';
                if(grade.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;">Nenhuma turma configurada ainda.</td></tr>';
                    return;
                }

                grade.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.hora}</td>
                        <td>${item.professor}</td>
                        <td>${item.nivel}</td>
                        <td><button class="delete-btn delete-grade-btn" data-index="${index}"><i class="ph-bold ph-trash"></i> Excluir</button></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function loadGradeOptions() {
                const gradeConfig = JSON.parse(localStorage.getItem('gradeHorarios')) || [];
                const selectElement = document.getElementById('grade-horario-cadastro');
                
                if(gradeConfig.length === 0) {
                    selectElement.innerHTML = '<option value="" disabled selected>Nenhum horário criado. Vá na aba "Grade de Aulas" primeiro.</option>';
                    return;
                }

                selectElement.innerHTML = '<option value="" disabled selected>Selecione a turma...</option>';
                gradeConfig.forEach(g => {
                    const option = document.createElement('option');
                    option.value = `${g.dia}|${g.hora}|${g.professor}`;
                    option.textContent = `${g.dia} às ${g.hora} - ${g.professor} (${g.nivel})`;
                    selectElement.appendChild(option);
                });
            }

            // --- FUNÇÕES DE CADASTRO E LISTAGEM DE ALUNOS ---
            document.getElementById('photo-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('photo-preview').innerHTML = `<img src="${event.target.result}" alt="Preview" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('cpf').addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g,"");
                v = v.replace(/(\d{3})(\d)/,"$1.$2");
                v = v.replace(/(\d{3})(\d)/,"$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");
                e.target.value = v.slice(0,14);
            });

            document.getElementById('celular').addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g,"");
                v = v.replace(/^(\d{2})(\d)/,"($1) $2");
                v = v.replace(/(\d{5})(\d)/,"$1-$2");
                e.target.value = v.slice(0,15);
            });

            document.getElementById('registrationForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const dataInicioString = document.getElementById('inicio').value;
                const planoSelecionadoForm = document.getElementById('plano').value;
                const gradeVal = document.getElementById('grade-horario-cadastro').value;

                let diasDeAula = [], horarioAula = '', professor = '';
                if(gradeVal) {
                    const parts = gradeVal.split('|');
                    diasDeAula = [parts[0]];
                    horarioAula = parts[1];
                    professor = parts[2];
                }

                // Calcular Vencimento Baseado nos Planos Dinâmicos
                const planosConfig = JSON.parse(localStorage.getItem('arenaPlanos')) || [];
                const planoConfigurado = planosConfig.find(p => p.nome === planoSelecionadoForm);
                const mesesDuracao = planoConfigurado ? planoConfigurado.duracao : 1; // Padrão 1 mês se der erro

                const dataInicio = new Date(dataInicioString + 'T12:00:00Z');
                let proximoPagamento = new Date(dataInicio);
                proximoPagamento.setMonth(proximoPagamento.getMonth() + mesesDuracao);

                const alunoData = {
                    matricula: `${new Date().getFullYear()}${Math.random().toString().slice(2, 8)}`,
                    nome: document.getElementById('nome').value,
                    cpf: document.getElementById('cpf').value,
                    nascimento: document.getElementById('nascimento').value,
                    celular: document.getElementById('celular').value,
                    email: document.getElementById('email').value,
                    plano: planoSelecionadoForm,
                    dataInicio: dataInicioString,
                    proximoPagamento: proximoPagamento.toISOString().split('T')[0],
                    diasDeAula: diasDeAula,
                    professor: professor,
                    horarioAula: horarioAula,
                    status: 'Ativo',
                    fotoUrl: document.getElementById('photo-preview').querySelector('img')?.src || ''
                };

                const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                alunos.push(alunoData);
                localStorage.setItem('alunos', JSON.stringify(alunos));

                alert(`Aluno cadastrado com sucesso! Matrícula: ${alunoData.matricula}`);
                
                e.target.reset();
                document.getElementById('photo-preview').innerHTML = '<span class="upload-icon"><i class="ph ph-camera-plus"></i></span><br><span>Enviar Foto</span>';
                loadStudentList();
                openTab(new Event('click'), 'Listar'); 
            });
        });

        function updateAllStudentStatuses() {
            let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            alunos.forEach(aluno => {
                if (aluno.proximoPagamento) {
                    const dueDate = new Date(aluno.proximoPagamento + 'T12:00:00Z');
                    aluno.status = dueDate < today ? 'Inativo' : 'Ativo';
                }
            });
            localStorage.setItem('alunos', JSON.stringify(alunos));
        }

        function getPaymentStatus(dueDateString) {
            if (!dueDateString) return { text: 'N/A', className: '' };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(dueDateString + 'T12:00:00Z');
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { text: 'Vencido', className: 'status-vencido' };
            if (diffDays <= 7) return { text: 'Vencendo', className: 'status-vencendo' };
            return { text: 'Em dia', className: 'status-em-dia' };
        }

        function loadStudentList() {
            const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const listBody = document.getElementById('student-list-body');
            listBody.innerHTML = '';
            
            alunos.forEach(aluno => {
                const row = document.createElement('tr');
                row.dataset.matricula = aluno.matricula;
                const vencimento = aluno.proximoPagamento ? new Date(aluno.proximoPagamento + 'T12:00:00Z').toLocaleDateString('pt-BR') : '-';
                const status = getPaymentStatus(aluno.proximoPagamento);
                
                let horarioDisplay = aluno.horarioAula || 'Não definido';
                if(aluno.diasDeAula && aluno.diasDeAula.length > 0) {
                     horarioDisplay = `${aluno.diasDeAula.join(', ')} - ${horarioDisplay}`;
                }

                row.innerHTML = `
                    <td><img src="${aluno.fotoUrl || 'https://placehold.co/40x40/2c2c2c/f0f0f0?text=S/F'}"> ${aluno.nome}</td>
                    <td>${aluno.plano}</td>
                    <td><small>${horarioDisplay}</small></td>
                    <td>${vencimento}</td>
                    <td><span class="status-tag ${status.className}">${status.text}</span></td>
                `;
                listBody.appendChild(row);
            });
        }

        // --- LÓGICA DO MODAL (DETALHES, PAGAMENTO DINÂMICO, EXCLUSÃO E EDIÇÃO) ---
        window.showStudentDetailsModal = function(matricula, isEditing = false) {
            const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const aluno = alunos.find(a => a.matricula === matricula);
            if (!aluno) return;

            const modal = document.getElementById('student-details-modal');
            const modalBody = document.getElementById('modal-content-body');
            const status = getPaymentStatus(aluno.proximoPagamento);
            
            // Grades
            const gradeConfig = JSON.parse(localStorage.getItem('gradeHorarios')) || [];
            let gradeSelectHtml = '';
            
            if (isEditing) {
                gradeSelectHtml = `<select id="edit-horario" style="width:100%; padding:10px;">
                    <option value="">Selecione um horário...</option>`;
                gradeConfig.forEach(g => {
                    const selected = (aluno.horarioAula === g.hora && (aluno.diasDeAula || []).includes(g.dia)) ? 'selected' : '';
                    gradeSelectHtml += `<option value="${g.dia}|${g.hora}|${g.professor}" ${selected}>${g.dia} às ${g.hora} - ${g.professor} (${g.nivel})</option>`;
                });
                gradeSelectHtml += `</select>`;
            } else {
                gradeSelectHtml = `<span>${aluno.diasDeAula ? aluno.diasDeAula.join(', ') : ''} às ${aluno.horarioAula || ''} (${aluno.professor || ''})</span>`;
            }

            // Planos Dinâmicos para Edição
            const planosConfig = JSON.parse(localStorage.getItem('arenaPlanos')) || [];
            let planosSelectHtml = '';
            if (isEditing) {
                planosSelectHtml = `<select id="edit-plano">`;
                planosConfig.forEach(p => {
                    const selected = (aluno.plano === p.nome) ? 'selected' : '';
                    planosSelectHtml += `<option value="${p.nome}" ${selected}>${p.nome}</option>`;
                });
                planosSelectHtml += `</select>`;
            }

            modalBody.innerHTML = `
                <div class="modal-header">
                    <img src="${aluno.fotoUrl || 'https://placehold.co/120x120/2c2c2c/f0f0f0?text=Foto'}" alt="Foto">
                    <h2>${aluno.nome} <br><small style="font-size:0.9rem; color:#aaa;">Matrícula: ${aluno.matricula}</small></h2>
                </div>
                
                <div class="modal-body">
                    <div class="detail-item"><strong>Status:</strong> <span class="status-tag ${status.className}">${status.text}</span></div>
                    
                    ${isEditing ? `
                        <div class="detail-item"><strong>Nome:</strong> <input type="text" id="edit-nome" value="${aluno.nome}"></div>
                        <div class="detail-item"><strong>Celular:</strong> <input type="text" id="edit-celular" value="${aluno.celular}"></div>
                        <div class="detail-item"><strong>Plano:</strong> ${planosSelectHtml}</div>
                    ` : `
                        <div class="detail-item"><strong>Plano:</strong> <span>${aluno.plano}</span></div>
                        <div class="detail-item"><strong>Celular:</strong> <span>${aluno.celular}</span></div>
                    `}
                    
                    <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                        <strong>Turma / Horário:</strong>
                        <div style="margin-top:5px; width:100%">${gradeSelectHtml}</div>
                    </div>
                    
                    <div class="detail-item"><strong>Vencimento Atual:</strong> <span>${new Date(aluno.proximoPagamento + 'T12:00:00Z').toLocaleDateString('pt-BR')}</span></div>
                </div>

                ${!isEditing ? `
                <div class="payment-section">
                    <h3 style="border-bottom:1px solid #555; padding-bottom:5px;">Registrar Pagamento / Renovar</h3>
                    <div class="payment-options">
                        <button class="pay-btn pay-manual" onclick="processPayment('${matricula}', 'Dinheiro')">
                            <i class="ph-bold ph-money"></i> Dinheiro
                        </button>
                        <button class="pay-btn pay-online" onclick="showOnlinePayment('${matricula}')">
                            <i class="ph-bold ph-qr-code"></i> Pix Online
                        </button>
                        <button class="pay-btn pay-credit" onclick="processPayment('${matricula}', 'Cartão de Crédito')">
                            <i class="ph-bold ph-credit-card"></i> C. Crédito
                        </button>
                        <button class="pay-btn pay-debit" onclick="processPayment('${matricula}', 'Cartão de Débito')">
                            <i class="ph-bold ph-credit-card"></i> C. Débito
                        </button>
                    </div>
                    <div id="qr-area-${matricula}" class="qr-display">
                        <p style="margin-bottom:10px;">Escaneie para pagar via Pix:</p>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PagamentoArenaLouzada-${matricula}" alt="QR Code Pix">
                        <br>
                        <button class="pay-btn" style="background:#555; color:white; margin-top:10px; width: 100%;" onclick="processPayment('${matricula}', 'Pix Online')">Confirmar Pagamento Automático</button>
                    </div>
                </div>
                ` : ''}

                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                    <button class="delete-btn" onclick="deleteStudent('${matricula}')"><i class="ph-bold ph-trash"></i> Excluir Aluno</button>
                    <div>
                        ${isEditing ? 
                            `<button class="btn-edit" onclick="saveEdit('${matricula}')">Salvar Alterações</button>` : 
                            `<button class="btn-edit" onclick="showStudentDetailsModal('${matricula}', true)">Editar Dados</button>`
                        }
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        window.saveEdit = function(matricula) {
            let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const idx = alunos.findIndex(a => a.matricula === matricula);
            if (idx > -1) {
                const gradeVal = document.getElementById('edit-horario').value;
                if(gradeVal) {
                    const [dia, hora, prof] = gradeVal.split('|');
                    alunos[idx].diasDeAula = [dia];
                    alunos[idx].horarioAula = hora;
                    alunos[idx].professor = prof;
                }

                alunos[idx].nome = document.getElementById('edit-nome').value;
                alunos[idx].celular = document.getElementById('edit-celular').value;
                alunos[idx].plano = document.getElementById('edit-plano').value;
                
                localStorage.setItem('alunos', JSON.stringify(alunos));
                showStudentDetailsModal(matricula, false); 
                loadStudentList(); 
                alert('Dados atualizados!');
            }
        }

        window.deleteStudent = function(matricula) {
            if(confirm('ATENÇÃO: Tem certeza que deseja excluir este aluno? Esta ação não pode ser desfeita.')) {
                let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                alunos = alunos.filter(a => a.matricula !== matricula); 
                localStorage.setItem('alunos', JSON.stringify(alunos)); 
                
                document.getElementById('student-details-modal').classList.remove('active'); 
                loadStudentList(); 
            }
        }

        window.showOnlinePayment = function(matricula) {
            const qrArea = document.getElementById(`qr-area-${matricula}`);
            qrArea.style.display = 'block';
        }

        // --- LÓGICA DE PAGAMENTO INTELIGENTE (Puxando valores da Configuração) ---
        window.processPayment = function(matricula, metodo) {
            let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const idx = alunos.findIndex(a => a.matricula === matricula);
            
            if (idx > -1 && confirm(`Confirmar pagamento via ${metodo}?`)) {
                const aluno = alunos[idx];
                
                // Busca o plano do aluno na lista de configurações
                const planosConfig = JSON.parse(localStorage.getItem('arenaPlanos')) || [];
                const planoAtual = planosConfig.find(p => p.nome === aluno.plano);

                let valor = 0;
                let meses = 1;

                if (planoAtual) {
                    valor = planoAtual.valor;
                    meses = planoAtual.duracao;
                } else {
                    alert("Aviso: O plano antigo deste aluno não existe mais nas Configurações. Renovando por 1 mês com valor zerado. Edite o plano dele depois!");
                }

                // Cálculo da nova data
                let dataAtual = new Date(aluno.proximoPagamento + 'T12:00:00Z');
                const hoje = new Date();
                if (dataAtual < hoje) { dataAtual = hoje; } // Se venceu há muito tempo, renova a partir de hoje
                
                dataAtual.setMonth(dataAtual.getMonth() + meses);

                aluno.proximoPagamento = dataAtual.toISOString().split('T')[0];
                aluno.status = 'Ativo';
                localStorage.setItem('alunos', JSON.stringify(alunos));

                // Lança no caixa o valor dinâmico
                if (valor > 0) {
                    const sale = {
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        client: `${aluno.nome} (Renovação - ${metodo})`,
                        total: valor,
                        items: [{name: `Plano ${aluno.plano}`, price: valor}]
                    };
                    const salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
                    salesHistory.push(sale);
                    localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
                }

                alert(`Pagamento registrado! Nova data de vencimento: ${dataAtual.toLocaleDateString('pt-BR')}`);
                document.getElementById('student-details-modal').classList.remove('active');
                loadStudentList();
            }
        }
    </script>
</body>
</html>
