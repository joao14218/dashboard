<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alunos - Arena Louzada</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root{--primary-color:#ffc400;--primary-hover-color:#e6b000;--dark-bg:#1a1a1a;--dark-card:#2c2c2c;--text-light:#f0f0f0;--text-muted:#a0a0a0;--border-color:#444;--success-color:#28a745;--danger-color:#e74c3c;--warning-color:#ffc400;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{display:flex;background-color:var(--dark-bg);color:var(--text-light)}
        .app-layout{display:flex;width:100%;min-height:100vh}
        .sidebar{width:240px;background-color:var(--dark-card);padding:20px;display:flex;flex-direction:column;border-right:1px solid var(--border-color)}
        .sidebar-header{text-align:center;margin-bottom:40px}.sidebar-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);margin-bottom:10px}
        .sidebar-header h2{font-size:1.2rem;color:var(--text-light)}
        .nav-menu{flex-grow:1}.nav-menu a{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:8px;text-decoration:none;color:var(--text-muted);font-weight:600;transition:background-color .3s,color .3s}.nav-menu a i{font-size:1.5rem;margin-right:15px}.nav-menu a.active,.nav-menu a:hover{background-color:var(--primary-color);color:#000}

        .main-content{flex-grow:1;padding:40px;overflow-y:auto}
        .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:30px}
        .tab-button{padding:15px 30px;cursor:pointer;background:none;border:none;color:var(--text-muted);font-size:1rem;font-weight:600}
        .tab-button.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
        .tab-content{display:none}.tab-content.active{display:block}
        
        .student-table-wrapper{overflow-x:auto; background-color: var(--dark-card); padding:20px; border-radius: 10px;}
        .student-table{width:100%;border-collapse:collapse; text-align:left;}
        .student-table th, .student-table td{padding:15px;border-bottom:1px solid var(--border-color)}
        .student-table th{font-size:0.9rem;text-transform:uppercase;color:var(--text-muted)}
        .student-table img{width:40px;height:40px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:10px}
        .student-table tbody tr {cursor: pointer; transition: background 0.2s;} .student-table tbody tr:hover{background: #333;}
        
        .status-tag{padding:5px 12px;border-radius:15px;font-weight:bold;font-size:.9rem;color:#fff}
        .status-em-dia{background-color:var(--success-color)}
        .status-vencendo{background-color:var(--warning-color); color: #000;}
        .status-vencido{background-color:var(--danger-color)}

        .form-card{background-color:var(--dark-card);padding:30px;border-radius:10px;max-width:800px;margin:auto}
        .registration-form-layout{display:flex;gap:40px;align-items:flex-start}
        @media (max-width: 768px) { .registration-form-layout { flex-direction: column; align-items: center; } }
        .photo-uploader{flex-shrink:0;width:180px;text-align:center;position:relative}.photo-uploader label{display:block;width:180px;height:180px;border:2px dashed var(--border-color);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#888;overflow:hidden}.photo-uploader .upload-icon{font-size:3rem}#photo-preview img{width:100%;height:100%;object-fit:cover}
        .form-fields{flex-grow:1; width:100%;}.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}.form-group.full-width{grid-column:1/-1}
        .form-group{margin-bottom:15px}
        .form-group label{display:block; margin-bottom:8px; font-weight:600;}
        .form-group input,.form-group select{width:100%;padding:12px;border-radius:8px;background-color:#3a3a3a;border:1px solid var(--border-color);color:var(--text-light);font-size:1rem}
        .submit-button{width:100%;padding:15px;border:none;border-radius:8px;background-color:var(--primary-color);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer}
        .delete-btn{background-color:var(--danger-color);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:5px;}
        .hidden{display:none}

        /* Modal Premium Styles */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal-content{background-color:var(--dark-card);padding:30px;border-radius:10px;width:100%;max-width:600px;position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
        .close-modal-btn{position:absolute;top:15px;right:15px;background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer; transition: color 0.2s;}
        .close-modal-btn:hover{color: var(--danger-color);}
        .modal-header{text-align:center; margin-bottom:20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        .modal-header img{width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-color);margin-bottom:10px}
        
        .detail-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #3a3a3a;align-items:center}.detail-item strong{color:var(--text-muted)}
        .detail-item input, .detail-item select{background-color:#4f4f4f;border:1px solid #666;text-align:right; color: var(--text-light); padding: 5px; border-radius: 5px;}
        
        /* Payment Section */
        .payment-section{background-color:#333; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #444;}
        .payment-options{display:flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;}
        .pay-btn{flex: 1 1 45%; padding: 12px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: transform 0.2s;}
        .pay-btn:hover{transform: translateY(-2px); filter: brightness(1.1);}
        
        .pay-manual{background-color: var(--success-color); color: white;}
        .pay-online{background-color: #0099ff; color: white;}
        .pay-credit{background-color: #e67e22; color: white;}
        .pay-debit{background-color: #9b59b6; color: white;}
        
        .qr-display{text-align: center; margin-top: 15px; display: none; background: #222; padding: 15px; border-radius: 8px;}
        .qr-display img{width: 180px; height: 180px; background: white; padding: 10px; border-radius: 8px;}

        .btn-edit{background-color:var(--primary-color);color:#000; padding:10px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;}
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="tabs" id="tabs-container">
                <button class="tab-button active" onclick="openTab(event, 'Listar')">Listar Alunos</button>
                <button class="tab-button" onclick="openTab(event, 'Cadastrar')">Cadastrar Aluno</button>
                <button class="tab-button" onclick="openTab(event, 'Grade')">Grade de Aulas</button>
            </div>
            
            <div id="Listar" class="tab-content active">
                <h2 id="lista-alunos-titulo">Lista de Alunos (Servidor)</h2>
                <div class="student-table-wrapper">
                    <table class="student-table">
                        <thead><tr><th>Aluno</th><th>Plano</th><th>Turma/Horário</th><th>Vencimento</th><th>Status</th></tr></thead>
                        <tbody id="student-list-body">
                            <tr><td colspan="5" style="text-align:center;">A carregar alunos da nuvem...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="Cadastrar" class="tab-content">
                <div class="form-card">
                    <h1 style="margin-bottom: 5px;">Cadastro Oficial</h1>
                    <p style="color: var(--text-muted); margin-bottom: 25px;">Os dados serão guardados na base de dados.</p>
                    
                    <form id="registrationForm">
                        <div class="registration-form-layout">
                            <div class="photo-uploader">
                                <label for="photo-input">
                                    <div id="photo-preview"><span class="upload-icon"><i class="ph ph-camera-plus"></i></span><br><span>Foto (Opcional)</span></div>
                                </label>
                                <input type="file" id="photo-input" accept="image/*" class="hidden">
                            </div>
                            
                            <div class="form-fields">
                                <div class="form-grid">
                                    <div class="form-group full-width">
                                        <label for="nome">Nome Completo</label>
                                        <input type="text" id="nome" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cpf">CPF</label>
                                        <input type="text" id="cpf" placeholder="000.000.000-00" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="nascimento">Data de Nascimento</label>
                                        <input type="date" id="nascimento" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="celular">Celular (WhatsApp)</label>
                                        <input type="tel" id="celular" placeholder="(00) 00000-0000" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input type="email" id="email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="plano">Plano Escolhido</label>
                                        <select id="plano" required>
                                            <option value="" disabled selected>A carregar planos...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="inicio">Data de Início</label>
                                        <input type="date" id="inicio" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label for="grade-horario-cadastro">Turma / Horário (Na Nuvem)</label>
                                        <select id="grade-horario-cadastro" required>
                                            <option value="" disabled selected>A carregar horários...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top:20px;">
                            <button type="submit" class="submit-button" id="btn-salvar">Gravar Aluno no Servidor</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="Grade" class="tab-content">
                <div class="form-card" style="max-width: 100%;">
                    <h2 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Gerir Turmas (Nuvem)</h2>
                    
                    <form id="form-horario" style="display: flex; gap: 15px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Dia da Semana</label>
                            <select id="dia-semana" required>
                                <option value="Segunda">Segunda-feira</option>
                                <option value="Terça">Terça-feira</option>
                                <option value="Quarta">Quarta-feira</option>
                                <option value="Quinta">Quinta-feira</option>
                                <option value="Sexta">Sexta-feira</option>
                                <option value="Sábado">Sábado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                            <label>Horário</label>
                            <input type="time" id="hora-inicio" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Professor</label>
                            <input type="text" id="nome-professor" placeholder="Ex: Prof. João" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                            <label>Nível</label>
                            <input type="text" id="nivel-turma" placeholder="Ex: Iniciante">
                        </div>
                        <button type="submit" class="submit-button" style="width: auto; padding: 12px 20px;">Adicionar Turma</button>
                    </form>

                    <div class="student-table-wrapper">
                        <table class="student-table">
                            <thead><tr><th>Dia</th><th>Horário</th><th>Professor</th><th>Nível</th><th>Ação</th></tr></thead>
                            <tbody id="lista-horarios-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="student-details-modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="fecharModal()"><i class="ph-bold ph-x"></i></button>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // AS 3 LISTAS OFICIAIS DA NUVEM
        let alunosGlobais = [];
        let turmasNuvem = []; 
        let planosGlobais = []; 

        document.addEventListener('DOMContentLoaded', () => {
            loadStudentList(); 
            loadGradeTable(); 
            loadPlanOptions(); // Agora puxa do banco de dados!
            
            window.openTab = function(evt, tabName) {
                document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
                document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.classList.add("active");
            }

            document.body.addEventListener('click', (e) => {
                if(e.target.classList.contains('modal-overlay')) { fecharModal(); }
            });

            document.getElementById('cpf').addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g,"");
                v = v.replace(/(\d{3})(\d)/,"$1.$2");
                v = v.replace(/(\d{3})(\d)/,"$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");
                e.target.value = v.slice(0,14);
            });
            document.getElementById('celular').addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g,"");
                v = v.replace(/^(\d{2})(\d)/,"($1) $2");
                v = v.replace(/(\d{5})(\d)/,"$1-$2");
                e.target.value = v.slice(0,15);
            });

            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btnSalvar = document.getElementById('btn-salvar');
                btnSalvar.textContent = "A Guardar...";
                btnSalvar.disabled = true;

                const gradeVal = document.getElementById('grade-horario-cadastro').value;
                let diasDeAula = [], horarioAula = '', professor = '';
                if(gradeVal) {
                    const parts = gradeVal.split('|');
                    diasDeAula = [parts[0]]; horarioAula = parts[1]; professor = parts[2];
                }

                const planoSelecionado = document.getElementById('plano').value;
                const planoConfigurado = planosGlobais.find(p => p.nome === planoSelecionado);
                const mesesDuracao = planoConfigurado ? planoConfigurado.duracao : 1;

                const dataInicio = document.getElementById('inicio').value;
                const proximoPag = new Date(dataInicio + 'T12:00:00Z');
                proximoPag.setMonth(proximoPag.getMonth() + mesesDuracao);
                
                const alunoData = {
                    nome: document.getElementById('nome').value,
                    cpf: document.getElementById('cpf').value,
                    nascimento: document.getElementById('nascimento').value,
                    celular: document.getElementById('celular').value,
                    email: document.getElementById('email').value,
                    plano: planoSelecionado,
                    data_inicio: dataInicio,
                    proximo_pagamento: proximoPag.toISOString().split('T')[0],
                    dias_aula: diasDeAula,
                    horario_aula: horarioAula,
                    professor: professor,
                    foto_url: document.getElementById('photo-preview').querySelector('img')?.src || ''
                };

                try {
                    const response = await fetch(`${window.API_URL}/alunos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionStorage.getItem('token')}` },
                        body: JSON.stringify(alunoData)
                    });

                    if (response.ok) {
                        alert("Aluno guardado com sucesso na Nuvem!");
                        e.target.reset();
                        document.getElementById('photo-preview').innerHTML = '<span class="upload-icon"><i class="ph ph-camera-plus"></i></span><br><span>Foto (Opcional)</span>';
                        loadStudentList();
                        openTab(new Event('click'), 'Listar');
                    } else { alert("Erro ao guardar no servidor."); }
                } catch (error) { alert("Erro de ligação."); } 
                finally { btnSalvar.textContent = "Gravar Aluno no Servidor"; btnSalvar.disabled = false; }
            });
        });

        // --- NOVA LÓGICA DE PLANOS (NUVEM) ---
        async function loadPlanOptions() {
            const selectPlano = document.getElementById('plano');
            selectPlano.innerHTML = '<option value="" disabled selected>A carregar planos da nuvem...</option>';
            try {
                const response = await fetch(`${window.API_URL}/planos`, { headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                if (response.ok) {
                    planosGlobais = await response.json();
                    selectPlano.innerHTML = '<option value="" disabled selected>Selecione um plano</option>';
                    if (planosGlobais.length === 0) {
                        selectPlano.innerHTML = '<option value="" disabled selected>Crie um plano nas Configurações</option>';
                    } else {
                        planosGlobais.forEach(p => { 
                            selectPlano.innerHTML += `<option value="${p.nome}">${p.nome} (R$ ${parseFloat(p.valor).toFixed(2)})</option>`; 
                        });
                    }
                }
            } catch(e) { selectPlano.innerHTML = '<option value="" disabled selected>Erro ao carregar planos</option>'; }
        }

        // --- LÓGICA DA GRADE (NUVEM) ---
        document.getElementById('form-horario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('.submit-button');
            btn.textContent = "A salvar..."; btn.disabled = true;

            const novoHorario = {
                dia: document.getElementById('dia-semana').value,
                hora: document.getElementById('hora-inicio').value,
                professor: document.getElementById('nome-professor').value,
                nivel: document.getElementById('nivel-turma').value || 'Geral'
            };

            try {
                await fetch(`${window.API_URL}/grade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionStorage.getItem('token')}` },
                    body: JSON.stringify(novoHorario)
                });
                e.target.reset(); 
                loadGradeTable(); 
            } catch (error) { alert("Erro ao salvar turma na nuvem."); }
            finally { btn.textContent = "Adicionar Turma"; btn.disabled = false; }
        });

        async function loadGradeTable() {
            const tbody = document.getElementById('lista-horarios-body');
            const selectElement = document.getElementById('grade-horario-cadastro');
            
            try {
                const response = await fetch(`${window.API_URL}/grade`, { headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                if (response.ok) {
                    turmasNuvem = await response.json();
                    turmasNuvem.sort((a,b) => (a.dia > b.dia) ? 1 : -1); 
                    
                    tbody.innerHTML = '';
                    if(turmasNuvem.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhuma turma cadastrada.</td></tr>';
                    } else {
                        turmasNuvem.forEach((item) => {
                            tbody.innerHTML += `<tr><td>${item.dia}</td><td>${item.hora}</td><td>${item.professor}</td><td>${item.nivel}</td>
                            <td><button class="delete-btn" onclick="deletarGrade(${item.id})"><i class="ph-bold ph-trash"></i></button></td></tr>`;
                        });
                    }

                    selectElement.innerHTML = '<option value="" disabled selected>Selecione a turma...</option>';
                    turmasNuvem.forEach(g => { 
                        selectElement.innerHTML += `<option value="${g.dia}|${g.hora}|${g.professor}">${g.dia} às ${g.hora} - ${g.professor}</option>`; 
                    });
                }
            } catch(e) { tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar turmas.</td></tr>'; }
        }

        window.deletarGrade = async function(id) {
            if(confirm("Apagar esta turma permanentemente?")) {
                try {
                    await fetch(`${window.API_URL}/grade/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                    loadGradeTable(); 
                } catch(e) { alert("Erro ao apagar."); }
            }
        }

        // --- LISTAGEM E STATUS ---
        function getPaymentStatus(dueDateString) {
            if (!dueDateString) return { text: 'N/A', className: '' };
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const dueDate = new Date(dueDateString + 'T12:00:00Z');
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { text: 'Vencido', className: 'status-vencido' };
            if (diffDays <= 7) return { text: 'Vencendo', className: 'status-vencendo' };
            return { text: 'Em dia', className: 'status-em-dia' };
        }

        async function loadStudentList() {
            const listBody = document.getElementById('student-list-body');
            try {
                const response = await fetch(`${window.API_URL}/alunos`, { headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                if (response.ok) {
                    alunosGlobais = await response.json();
                    listBody.innerHTML = '';
                    if(alunosGlobais.length === 0) {
                        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum aluno cadastrado.</td></tr>'; return;
                    }
                    alunosGlobais.forEach(aluno => {
                        const status = getPaymentStatus(aluno.proximo_pagamento);
                        const vencimento = aluno.proximo_pagamento ? new Date(aluno.proximo_pagamento + 'T12:00:00Z').toLocaleDateString('pt-BR') : '-';
                        let dias = ''; try { dias = typeof aluno.dias_aula === 'string' ? JSON.parse(aluno.dias_aula).join(', ') : (aluno.dias_aula ? aluno.dias_aula.join(', ') : ''); } catch(e){}
                        const nomePlanoVisual = (!aluno.plano || aluno.plano === 'undefined' || aluno.plano === 'null') ? 'Sem Plano' : aluno.plano;

                        const tr = document.createElement('tr');
                        tr.onclick = () => showStudentDetailsModal(aluno.matricula);
                        tr.innerHTML = `
                            <td><img src="${aluno.foto_url || 'https://placehold.co/40x40/2c2c2c/f0f0f0?text=S/F'}"> ${aluno.nome}</td>
                            <td>${nomePlanoVisual}</td>
                            <td><small>${dias} às ${aluno.horario_aula || ''}</small></td>
                            <td>${vencimento}</td>
                            <td><span class="status-tag ${status.className}">${status.text}</span></td>
                        `;
                        listBody.appendChild(tr);
                    });
                }
            } catch (error) { listBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Erro ao buscar dados do servidor.</td></tr>'; }
        }

        // --- MODAL PREMIUM ---
        window.showStudentDetailsModal = function(matricula, isEditing = false) {
            const aluno = alunosGlobais.find(a => a.matricula === matricula);
            if (!aluno) return;

            const modal = document.getElementById('student-details-modal');
            const modalBody = document.getElementById('modal-content-body');
            const status = getPaymentStatus(aluno.proximo_pagamento);
            let diasStr = ''; try { diasStr = typeof aluno.dias_aula === 'string' ? JSON.parse(aluno.dias_aula).join(', ') : (aluno.dias_aula ? aluno.dias_aula.join(', ') : ''); } catch(e){}
            const nomePlanoVisual = (!aluno.plano || aluno.plano === 'undefined' || aluno.plano === 'null') ? 'Sem Plano' : aluno.plano;

            let gradeSelectHtml = `<span>${diasStr} às ${aluno.horario_aula || ''} (${aluno.professor || ''})</span>`;
            let planosSelectHtml = `<span>${nomePlanoVisual}</span>`;
            
            if (isEditing) {
                gradeSelectHtml = `<select id="edit-horario" style="width:100%; padding:8px;"><option value="">Selecione...</option>`;
                turmasNuvem.forEach(g => {
                    const selected = (aluno.horario_aula === g.hora) ? 'selected' : '';
                    gradeSelectHtml += `<option value="${g.dia}|${g.hora}|${g.professor}" ${selected}>${g.dia} às ${g.hora}</option>`;
                });
                gradeSelectHtml += `</select>`;

                // Agora puxa os planos da NUVEM!
                planosSelectHtml = `<select id="edit-plano" style="width:100%; padding:8px;"><option value="">Selecione...</option>`;
                planosGlobais.forEach(p => {
                    const selected = (aluno.plano === p.nome) ? 'selected' : '';
                    planosSelectHtml += `<option value="${p.nome}" ${selected}>${p.nome}</option>`;
                });
                planosSelectHtml += `</select>`;
            }

            modalBody.innerHTML = `
                <div class="modal-header">
                    <img src="${aluno.foto_url || 'https://placehold.co/100x100/2c2c2c/f0f0f0?text=Foto'}" alt="Foto">
                    <h2>${aluno.nome} <br><small style="font-size:0.9rem; color:#aaa;">Matrícula: ${aluno.matricula}</small></h2>
                </div>
                
                <div class="modal-body">
                    <div class="detail-item"><strong>Status:</strong> <span class="status-tag ${status.className}">${status.text}</span></div>
                    
                    ${isEditing ? `
                        <div class="detail-item"><strong>Nome:</strong> <input type="text" id="edit-nome" value="${aluno.nome || ''}"></div>
                        <div class="detail-item"><strong>Celular:</strong> <input type="text" id="edit-celular" value="${aluno.celular || ''}"></div>
                        <div class="detail-item" style="flex-direction:column; align-items:flex-start;"><strong>Plano:</strong> <div style="margin-top:5px;width:100%">${planosSelectHtml}</div></div>
                        <div class="detail-item" style="flex-direction:column; align-items:flex-start;"><strong>Turma:</strong> <div style="margin-top:5px;width:100%">${gradeSelectHtml}</div></div>
                        <div class="detail-item"><strong>Vencimento:</strong> <input type="date" id="edit-vencimento" value="${aluno.proximo_pagamento || ''}" style="background-color:#4f4f4f; border:1px solid #666; color:white; padding:5px; border-radius:5px;"></div>
                    ` : `
                        <div class="detail-item"><strong>Plano:</strong> ${planosSelectHtml}</div>
                        <div class="detail-item"><strong>Celular:</strong> <span>${aluno.celular || 'N/A'}</span></div>
                        <div class="detail-item"><strong>Turma:</strong> ${gradeSelectHtml}</div>
                        <div class="detail-item"><strong>Vencimento Atual:</strong> <span>${aluno.proximo_pagamento ? new Date(aluno.proximo_pagamento + 'T12:00:00Z').toLocaleDateString('pt-BR') : 'N/A'}</span></div>
                    `}
                </div>

                ${!isEditing ? `
                <div class="payment-section">
                    <h3 style="border-bottom:1px solid #555; padding-bottom:10px;"><i class="ph-bold ph-wallet"></i> Renovar / Pagar Mensalidade</h3>
                    <div class="payment-options">
                        <button class="pay-btn pay-manual" onclick="processPayment('${aluno.matricula}', 'Dinheiro')"><i class="ph-bold ph-money"></i> Dinheiro</button>
                        <button class="pay-btn pay-online" onclick="document.getElementById('qr-area').style.display='block'"><i class="ph-bold ph-qr-code"></i> Pix Online</button>
                        <button class="pay-btn pay-credit" onclick="processPayment('${aluno.matricula}', 'Cartão de Crédito')"><i class="ph-bold ph-credit-card"></i> C. Crédito</button>
                        <button class="pay-btn pay-debit" onclick="processPayment('${aluno.matricula}', 'Cartão de Débito')"><i class="ph-bold ph-credit-card"></i> C. Débito</button>
                    </div>
                    <div id="qr-area" class="qr-display">
                        <p style="margin-bottom:10px; color: #fff;">Escaneie para pagar via Pix:</p>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PagamentoArenaLouzada-${aluno.matricula}">
                        <br><button class="btn-edit" style="margin-top:15px; width: 100%;" onclick="processPayment('${aluno.matricula}', 'Pix Online')">Confirmar Recebimento</button>
                    </div>
                </div>
                ` : ''}

                <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center;">
                    <button class="delete-btn" onclick="deletarAlunoServidor('${aluno.matricula}')"><i class="ph-bold ph-trash"></i> Excluir Aluno</button>
                    <div>
                        ${isEditing ? 
                            `<button class="btn-edit" onclick="saveEdit('${aluno.matricula}')"><i class="ph-bold ph-floppy-disk"></i> Salvar Edição</button>` : 
                            `<button class="btn-edit" onclick="showStudentDetailsModal('${aluno.matricula}', true)"><i class="ph-bold ph-pencil-simple"></i> Editar</button>`
                        }
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        window.fecharModal = function() { document.getElementById('student-details-modal').classList.remove('active'); }

        window.processPayment = async function(matricula, metodo) {
            const aluno = alunosGlobais.find(a => a.matricula === matricula);
            if (!aluno) return;

            if (confirm(`Confirmar o pagamento do aluno ${aluno.nome} via ${metodo}?`)) {
                // Agora puxa o valor oficial da nuvem!
                const planoAtual = planosGlobais.find(p => p.nome === aluno.plano);
                const valor = planoAtual ? planoAtual.valor : 100;
                const meses = planoAtual ? planoAtual.duracao : 1;

                let dataVenc = new Date(aluno.proximo_pagamento + 'T12:00:00Z');
                const hoje = new Date(); hoje.setHours(0,0,0,0);
                if (dataVenc < hoje) { dataVenc = hoje; } 
                dataVenc.setMonth(dataVenc.getMonth() + meses);
                const novaDataStr = dataVenc.toISOString().split('T')[0];

                try {
                    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionStorage.getItem('token')}` };
                    const putResponse = await fetch(`${window.API_URL}/alunos/${matricula}`, { method: 'PUT', headers, body: JSON.stringify({ proximo_pagamento: novaDataStr }) });
                    if (!putResponse.ok) throw new Error("Erro no PUT");

                    if (valor > 0) {
                        await fetch(`${window.API_URL}/vendas`, {
                            method: 'POST', headers, body: JSON.stringify({
                                data: hoje.toISOString().split('T')[0],
                                cliente: `${aluno.nome} (Mensalidade - ${metodo})`,
                                total: valor,
                                itens: [{ name: `Plano ${aluno.plano || 'Base'}`, price: valor }]
                            })
                        });
                    }
                    alert(`Pagamento registado!\nNova data: ${dataVenc.toLocaleDateString('pt-BR')}`);
                    fecharModal(); loadStudentList(); 
                } catch (error) { alert('Erro de comunicação.'); }
            }
        }

        window.saveEdit = async function(matricula) {
            const editPlano = document.getElementById('edit-plano');
            const planoSalvo = (editPlano && editPlano.value !== "") ? editPlano.value : "Sem Plano";

            const data = {
                nome: document.getElementById('edit-nome').value,
                celular: document.getElementById('edit-celular').value,
                plano: planoSalvo,
                proximo_pagamento: document.getElementById('edit-vencimento').value
            };
            
            const editHorario = document.getElementById('edit-horario');
            if(editHorario && editHorario.value) {
                const parts = editHorario.value.split('|');
                data.dias_aula = [parts[0]]; data.horario_aula = parts[1]; data.professor = parts[2];
            }

            try {
                const response = await fetch(`${window.API_URL}/alunos/${matricula}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionStorage.getItem('token')}` },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Dados atualizados com sucesso!');
                    fecharModal(); loadStudentList();
                } else {
                    alert('Erro ao gravar no servidor.');
                }
            } catch (e) { alert('Erro de conexão.'); }
        }

        window.deletarAlunoServidor = async function(matricula) {
            if(confirm('Tem a certeza que deseja excluir permanentemente este aluno do Banco de Dados?')) {
                try {
                    await fetch(`${window.API_URL}/alunos/${matricula}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                    fecharModal(); loadStudentList();
                } catch(e) { alert('Erro ao excluir.'); }
            }
        }
    </script>
</body>
</html>
