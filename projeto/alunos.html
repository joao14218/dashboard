<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alunos - Arena Louzada</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root{--primary-color:#ffc400;--primary-hover-color:#e6b000;--dark-bg:#1a1a1a;--dark-card:#2c2c2c;--text-light:#f0f0f0;--text-muted:#a0a0a0;--border-color:#444;--success-color:#28a745;--danger-color:#e74c3c;--warning-color:#ffc400;}*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}body{display:flex;background-color:var(--dark-bg);color:var(--text-light)}
        .app-layout{display:flex;width:100%;min-height:100vh}
        .sidebar{width:240px;background-color:var(--dark-card);padding:20px;display:flex;flex-direction:column;border-right:1px solid var(--border-color)}
        
        /* ESTILOS CORRIGIDOS/ADICIONADOS */
        .sidebar-header{text-align:center;margin-bottom:40px}.sidebar-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);margin-bottom:10px}
        .sidebar-header h2{font-size:1.2rem;color:var(--text-light)}
        .nav-menu{flex-grow:1}.nav-menu a{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:8px;text-decoration:none;color:var(--text-muted);font-weight:600;transition:background-color .3s,color .3s}.nav-menu a i{font-size:1.5rem;margin-right:15px}.nav-menu a.active,.nav-menu a:hover{background-color:var(--primary-color);color:#000}

        .main-content{flex-grow:1;padding:40px;overflow-y:auto}
        .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:30px}
        .tab-button{padding:15px 30px;cursor:pointer;background:none;border:none;color:var(--text-muted);font-size:1rem;font-weight:600}
        .tab-button.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
        .tab-content{display:none}.tab-content.active{display:block}
        .form-card{background-color:var(--dark-card);padding:30px;border-radius:10px;max-width:800px;margin:auto}
        .form-group{margin-bottom:15px}
        .form-group label{display:block; margin-bottom:8px; font-weight:600;}
        .form-group input,.form-group select{width:100%;padding:12px;border-radius:8px;background-color:#3a3a3a;border:1px solid var(--border-color);color:var(--text-light);font-size:1rem}
        .submit-button{width:100%;padding:15px;border:none;border-radius:8px;background-color:var(--primary-color);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer}
        .student-table-wrapper{overflow-x:auto; background-color: var(--dark-card); padding:20px; border-radius: 10px;}
        .student-table{width:100%;border-collapse:collapse; text-align:left;}
        .student-table th, .student-table td{padding:15px;border-bottom:1px solid var(--border-color)}
        .student-table th{font-size:0.9rem;text-transform:uppercase;color:var(--text-muted)}
        .student-table img{width:40px;height:40px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:10px}
        .student-table tbody tr {cursor: pointer;}
        .remove-btn{background-color:var(--danger-color);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
        .registration-form-layout{display:flex;gap:40px;align-items:flex-start}
        .photo-uploader{flex-shrink:0;width:180px;text-align:center;position:relative}.photo-uploader label{display:block;width:180px;height:180px;border:2px dashed var(--border-color);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#888;overflow:hidden}.photo-uploader .upload-icon{font-size:3rem}#photo-preview img{width:100%;height:100%;object-fit:cover}.remove-photo-btn{background:var(--danger-color);color:white;border:none;border-radius:50%;width:30px;height:30px;position:absolute;top:-5px;right:-5px;font-size:1.2rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center}.form-fields{flex-grow:1}.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}.form-group.full-width{grid-column:1/-1}
        .status-tag{padding:5px 12px;border-radius:15px;font-weight:bold;font-size:.9rem;color:#fff}
        .status-em-dia{background-color:var(--success-color)}
        .status-vencendo{background-color:var(--warning-color); color: #000;}
        .status-vencido{background-color:var(--danger-color)}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal-content{background-color:var(--dark-card);padding:30px;border-radius:10px;width:100%;max-width:500px;position: relative; max-height: 90vh; overflow-y: auto;}
        .close-modal-btn{position:absolute;top:15px;right:15px;background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;}
        .modal-header{text-align:center; margin-bottom:20px;}.modal-header img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-color);margin-bottom:10px}
        .modal-body .detail-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color);align-items:center}.modal-body .detail-item strong{color:var(--text-muted)}
        .modal-body .detail-item input, .modal-body .detail-item select{background-color:#4f4f4f;border:1px solid #666;text-align:right; color: var(--text-light); padding: 5px; border-radius: 5px;}
        .contact-link{color:var(--text-light);text-decoration:none;display:flex;align-items:center;gap:8px}.contact-link i{font-size:1.2rem}
        .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
        .modal-footer button{padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem}
        .btn-edit{background-color:var(--primary-color);color:#000}
        .btn-paid{background-color:var(--success-color);color:#fff}
        .dias-aula-container{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start}.dias-aula-container label{display:flex;align-items:center;gap:5px;background-color:#3a3a3a;padding:8px 12px;border-radius:20px;font-size:0.9rem;cursor:pointer}.dias-aula-container input{margin-right:5px;}
        .hidden{display:none}
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="tabs" id="tabs-container">
                <button class="tab-button active" onclick="openTab(event, 'Listar')">Listar Alunos</button>
                <button class="tab-button" onclick="openTab(event, 'Cadastrar')">Cadastrar Aluno</button>
                <button class="tab-button" onclick="openTab(event, 'Validar')">Validar Matrícula</button>
            </div>
            <div id="Listar" class="tab-content active">
                <h2 id="lista-alunos-titulo">Lista de Alunos</h2>
                <div class="student-table-wrapper">
                    <table class="student-table">
                        <thead><tr><th>Aluno</th><th>Status Geral</th><th>Plano</th><th>Próx. Vencimento</th><th>Status Pag.</th><th>Ações</th></tr></thead>
                        <tbody id="student-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="Cadastrar" class="tab-content"></div>
            <div id="Validar" class="tab-content"></div>
        </main>
    </div>
    <div class="modal-overlay" id="student-details-modal">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!currentUser) { window.location.href = 'login.html'; return; }
            
            if (currentUser.role === 'Professor') {
                const tabsContainer = document.getElementById('tabs-container');
                tabsContainer.querySelectorAll('.tab-button').forEach(button => {
                    const tabText = button.textContent.trim();
                    if (tabText === 'Cadastrar Aluno' || tabText === 'Validar Matrícula') {
                        button.style.display = 'none';
                    }
                });
            }
            updateAllStudentStatuses();
            injectForms();
            loadStudentList();
            addFormListeners();
        });
        
        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
            document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }
        function updateAllStudentStatuses() {
            let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            let hasChanges = false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            alunos.forEach(aluno => {
                if (aluno.proximoPagamento) {
                    const dueDate = new Date(aluno.proximoPagamento + 'T12:00:00Z');
                    const newStatus = dueDate < today ? 'Inativo' : 'Ativo';
                    if (aluno.status !== newStatus) {
                        aluno.status = newStatus;
                        hasChanges = true;
                    }
                }
            });
            if (hasChanges) localStorage.setItem('alunos', JSON.stringify(alunos));
        }
        function getPaymentStatus(dueDateString) {
            if (!dueDateString) return { text: 'N/A', className: '' };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(dueDateString + 'T12:00:00Z');
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: 'Vencido', className: 'status-vencido' };
            if (diffDays <= 7) return { text: 'Vencendo', className: 'status-vencendo' };
            return { text: 'Em dia', className: 'status-em-dia' };
        }
        function removeAluno(matricula) {
            if (confirm(`Tem certeza que deseja remover o aluno de matrícula ${matricula}?`)) {
                let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                alunos = alunos.filter(aluno => aluno.matricula !== matricula);
                localStorage.setItem('alunos', JSON.stringify(alunos));
                loadStudentList();
            }
        }
        function loadStudentList() {
            const urlParams = new URLSearchParams(window.location.search);
            const filtro = urlParams.get('filtro');
            let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const listBody = document.getElementById('student-list-body');
            const listTitle = document.getElementById('lista-alunos-titulo');
            if (filtro === 'vencido') {
                alunos = alunos.filter(aluno => aluno.status === 'Inativo');
                listTitle.textContent = "Alunos com Mensalidade Vencida";
            } else {
                listTitle.textContent = "Lista de Alunos";
            }
            listBody.innerHTML = '';
            if (alunos.length === 0) {
                const message = filtro === 'vencido' ? 'Nenhum aluno com mensalidade vencida.' : 'Nenhum aluno cadastrado.';
                listBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${message}</td></tr>`;
            } else {
                alunos.forEach(aluno => {
                    const row = document.createElement('tr');
                    row.dataset.matricula = aluno.matricula;
                    const vencimentoFormatado = aluno.proximoPagamento ? new Date(aluno.proximoPagamento + 'T12:00:00Z').toLocaleDateString('pt-BR') : 'N/A';
                    const paymentStatus = getPaymentStatus(aluno.proximoPagamento);
                    row.innerHTML = `
                        <td><img src="${aluno.fotoUrl || 'https://placehold.co/40x40/2c2c2c/f0f0f0?text=S/F'}" alt="Foto"> ${aluno.nome}</td>
                        <td>${aluno.status}</td>
                        <td>${aluno.plano}</td>
                        <td>${vencimentoFormatado}</td>
                        <td><span class="status-tag ${paymentStatus.className}">${paymentStatus.text}</span></td>
                        <td><button class="remove-btn" data-matricula="${aluno.matricula}">Remover</button></td>
                    `;
                    listBody.appendChild(row);
                });
            }
        }
        function showStudentDetailsModal(matricula, isEditing = false) {
            const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
            const aluno = alunos.find(a => a.matricula === matricula);
            if (!aluno) return;
            const modal = document.getElementById('student-details-modal');
            const modalBody = document.getElementById('modal-content-body');
            const paymentStatus = getPaymentStatus(aluno.proximoPagamento);
            const vencimentoFormatado = aluno.proximoPagamento ? new Date(aluno.proximoPagamento + 'T12:00:00Z').toLocaleDateString('pt-BR') : 'N/A';
            const inicioFormatado = aluno.dataInicio ? new Date(aluno.dataInicio + 'T12:00:00Z').toLocaleDateString('pt-BR') : 'N/A';
            const celularLimpo = aluno.celular.replace(/\D/g, '');
            const whatsappLink = `https://wa.me/55${celularLimpo}`;
            const emailLink = `mailto:${aluno.email}`;
            const diasSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            let diasDeAulaHtml = '';
            if (isEditing) {
                diasDeAulaHtml = diasSemana.map(dia => `
                    <label>
                        <input type="checkbox" name="edit-diasAula" value="${dia}" ${(aluno.diasDeAula || []).includes(dia) ? 'checked' : ''}>
                        ${dia.substring(0,3)}
                    </label>
                `).join('');
            } else {
                diasDeAulaHtml = `<span>${(aluno.diasDeAula || []).join(', ') || 'Não definido'}</span>`;
            }
            modalBody.innerHTML = `
                <div class="modal-header">
                    <img src="${aluno.fotoUrl || 'https://placehold.co/120x120/2c2c2c/f0f0f0?text=S/F'}" alt="Foto do Aluno">
                    <h2>${isEditing ? `<input type="text" id="edit-nome" value="${aluno.nome}">` : aluno.nome}</h2>
                </div>
                <div class="modal-body">
                    <div class="detail-item"><strong>Status Pagamento:</strong><span class="status-tag ${paymentStatus.className}">${paymentStatus.text}</span></div>
                    <div class="detail-item"><strong>Status Geral:</strong><span>${aluno.status}</span></div>
                    <div class="detail-item"><strong>Dias de Aula:</strong>${isEditing ? `<div class="dias-aula-container">${diasDeAulaHtml}</div>` : diasDeAulaHtml}</div>
                    <div class="detail-item"><strong>Professor:</strong>${isEditing ? `<input type="text" id="edit-professor" value="${aluno.professor || ''}">` : `<span>${aluno.professor || 'Não definido'}</span>`}</div>
                    <div class="detail-item"><strong>Horário da Aula:</strong>${isEditing ? `<input type="time" id="edit-horarioAula" value="${aluno.horarioAula || ''}">` : `<span>${aluno.horarioAula || 'Não definido'}</span>`}</div>
                    <div class="detail-item"><strong>Matrícula:</strong><span>${aluno.matricula}</span></div>
                    <div class="detail-item"><strong>Plano:</strong>${isEditing ? `<select id="edit-plano"><option value="Mensal" ${aluno.plano === 'Mensal' ? 'selected' : ''}>Mensal</option><option value="Trimestral" ${aluno.plano === 'Trimestral' ? 'selected' : ''}>Trimestral</option><option value="Anual" ${aluno.plano === 'Anual' ? 'selected' : ''}>Anual</option></select>` : `<span>${aluno.plano}</span>`}</div>
                    <div class="detail-item"><strong>Próx. Vencimento:</strong>${isEditing ? `<input type="date" id="edit-vencimento" value="${aluno.proximoPagamento}">` : `<span>${vencimentoFormatado}</span>`}</div>
                    <div class="detail-item"><strong>Data de Início:</strong><span>${inicioFormatado}</span></div>
                    <div class="detail-item"><strong>Celular:</strong>${isEditing ? `<input type="tel" id="edit-celular" value="${aluno.celular}">` : `<a href="${whatsappLink}" target="_blank" class="contact-link">${aluno.celular} <i class="ph-bold ph-whatsapp-logo"></i></a>`}</div>
                    <div class="detail-item"><strong>Email:</strong>${isEditing ? `<input type="email" id="edit-email" value="${aluno.email}">` : `<a href="${emailLink}" class="contact-link">${aluno.email} <i class="ph-bold ph-envelope"></i></a>`}</div>
                    <div class="detail-item"><strong>CPF:</strong><span>${aluno.cpf}</span></div>
                </div>
                <div class="modal-footer">
                    ${isEditing ? `<button class="btn-edit" data-action="save" data-matricula="${aluno.matricula}">Salvar Alterações</button>` : `<button class="btn-edit" data-action="edit" data-matricula="${aluno.matricula}">Editar Dados</button>`}
                    <button class="btn-paid" data-action="paid" data-matricula="${aluno.matricula}">Marcar como Pago</button>
                </div>
            `;
            modal.classList.add('active');
        }
        function injectForms() {
            const diasSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            const diasDeAulaCheckboxes = diasSemana.map(dia => `
                <label>
                    <input type="checkbox" name="diasAula" value="${dia}">
                    ${dia}
                </label>
            `).join('');
            document.getElementById('Cadastrar').innerHTML = `<div class="form-card"><h1>Cadastro de Novo Aluno</h1><p>Preencha os dados e adicione uma foto para o perfil.</p><div id="feedback-cadastro" class="hidden"></div><form id="registrationForm"><div class="registration-form-layout"><div class="photo-uploader"><label for="photo-input"><div id="photo-preview"><span class="upload-icon"><i class="ph ph-camera-plus"></i></span></div></label><input type="file" id="photo-input" accept="image/*" class="hidden"><button type="button" id="remove-photo-btn" class="remove-photo-btn hidden">&times;</button><p>Foto do Aluno</p></div><div class="form-fields"><div class="form-grid"><div class="form-group full-width"><label for="nome">Nome Completo</label><input type="text" id="nome" required></div><div class="form-group"><label for="cpf">CPF</label><input type="text" id="cpf" placeholder="000.000.000-00" required></div><div class="form-group"><label for="nascimento">Data de Nascimento</label><input type="date" id="nascimento" required></div><div class="form-group"><label for="celular">Celular (WhatsApp)</label><input type="tel" id="celular" placeholder="(00) 00000-0000" required></div><div class="form-group"><label for="email">Email</label><input type="email" id="email" required></div><div class="form-group"><label for="plano">Plano Escolhido</label><select id="plano" required><option value="" disabled selected>Selecione um plano</option><option value="Mensal">Plano Mensal</option><option value="Trimestral">Plano Trimestral</option><option value="Anual">Plano Anual</option></select></div><div class="form-group"><label for="inicio">Data de Início</label><input type="date" id="inicio" required></div><div class="form-group"><label for="professor">Professor</label><input type="text" id="professor" placeholder="Nome do professor"></div><div class="form-group"><label for="horarioAula">Horário da Aula</label><input type="time" id="horarioAula"></div></div><div class="form-group full-width"><label>Dias de Aula</label><div class="dias-aula-container">${diasDeAulaCheckboxes}</div></div></div></div><div class="form-actions" style="margin-top:20px;"><button type="submit" class="submit-button">Cadastrar Aluno</button></div></form></div>`;
            document.getElementById('Validar').innerHTML = `<div class="form-card" style="max-width: 500px;"><h1>Validação de Alunos</h1><p>Digite a matrícula para buscar.</p><form id="validationForm"><div class="form-group"><input type="number" id="matricula-busca" placeholder="Digite a matrícula do aluno" required></div><button type="submit" class="submit-button">Verificar Aluno</button></form><div id="result-validacao" style="margin-top: 20px;"></div></div>`;
        }
        function addFormListeners() {
            document.body.addEventListener('submit', (e) => {
                if (e.target.id === 'registrationForm') {
                    e.preventDefault();
                    const dataInicioString = document.getElementById('inicio').value;
                    const plano = document.getElementById('plano').value;
                    if (!dataInicioString || !plano) { alert("Por favor, preencha a Data de Início e o Plano."); return; }
                    const dataInicio = new Date(dataInicioString + 'T12:00:00Z');
                    let proximoPagamento = new Date(dataInicio);
                    switch(plano) {
                        case 'Mensal': proximoPagamento.setMonth(proximoPagamento.getMonth() + 1); break;
                        case 'Trimestral': proximoPagamento.setMonth(proximoPagamento.getMonth() + 3); break;
                        case 'Anual': proximoPagamento.setFullYear(proximoPagamento.getFullYear() + 1); break;
                    }
                    const proximoPagamentoString = proximoPagamento.toISOString().split('T')[0];
                    const proximoPagamentoFormatado = proximoPagamento.toLocaleDateString('pt-BR');
                    const newMatricula = `${new Date().getFullYear()}${Math.random().toString().slice(2, 8)}`;
                    const fotoInput = document.getElementById('photo-input');
                    const diasDeAula = Array.from(document.querySelectorAll('input[name="diasAula"]:checked')).map(cb => cb.value);
                    const professor = document.getElementById('professor').value;
                    const horarioAula = document.getElementById('horarioAula').value;
                    const alunoData = { matricula: newMatricula, nome: document.getElementById('nome').value, cpf: document.getElementById('cpf').value, nascimento: document.getElementById('nascimento').value, celular: document.getElementById('celular').value, email: document.getElementById('email').value, plano: plano, dataInicio: dataInicioString, proximoPagamento: proximoPagamentoString, diasDeAula: diasDeAula, professor: professor, horarioAula: horarioAula, status: 'Ativo', fotoUrl: '' };
                    const saveStudent = (data) => {
                        const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                        alunos.push(data);
                        localStorage.setItem('alunos', JSON.stringify(alunos));
                        showFeedback(`Aluno cadastrado! Matrícula: ${data.matricula}.<br>Próximo Vencimento: ${proximoPagamentoFormatado}`, 'success', 'feedback-cadastro');
                        e.target.reset();
                        document.querySelector('#remove-photo-btn')?.click();
                        loadStudentList();
                    };
                    if (fotoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onloadend = () => { alunoData.fotoUrl = reader.result; saveStudent(alunoData); };
                        reader.readAsDataURL(fotoInput.files[0]);
                    } else { saveStudent(alunoData); }
                }
                if (e.target.id === 'validationForm') {
                    e.preventDefault();
                    const matricula = document.getElementById('matricula-busca').value;
                    const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                    const aluno = alunos.find(a => a.matricula === matricula);
                    const resultDiv = document.getElementById('result-validacao');
                    if (aluno) {
                        const paymentStatus = getPaymentStatus(aluno.proximoPagamento);
                        resultDiv.innerHTML = `<div style="text-align:center;"><img src="${aluno.fotoUrl || 'https://placehold.co/100x100'}" style="width:100px; height:100px; border-radius:50%;"><p><strong>Nome:</strong> ${aluno.nome}</p><p><strong>Status Geral:</strong> ${aluno.status}</p><p><strong>Status Pag.:</strong> <span class="status-tag ${paymentStatus.className}">${paymentStatus.text}</span></p></div>`;
                    } else {
                        resultDiv.innerHTML = `<p style="color:var(--danger-color); text-align:center;">Matrícula não encontrada.</p>`;
                    }
                }
            });
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('#remove-photo-btn')) {
                    document.getElementById('photo-input').value = '';
                    document.getElementById('photo-preview').innerHTML = '<span class="upload-icon"><i class="ph ph-camera-plus"></i></span>';
                    document.getElementById('remove-photo-btn').classList.add('hidden');
                }
                const removeBtn = e.target.closest('.remove-btn');
                if(removeBtn) {
                    e.stopPropagation();
                    removeAluno(removeBtn.dataset.matricula);
                }
                const studentRow = e.target.closest('#student-list-body tr');
                if(studentRow && !e.target.closest('.remove-btn')) {
                    showStudentDetailsModal(studentRow.dataset.matricula);
                }
                const modalActionBtn = e.target.closest('.modal-footer button');
                if(modalActionBtn) {
                    const { action, matricula } = modalActionBtn.dataset;
                    if(action === 'edit') showStudentDetailsModal(matricula, true);
                    if(action === 'paid') {
                        let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                        const alunoIndex = alunos.findIndex(a => a.matricula === matricula);
                        if (alunoIndex > -1) {
                            let proximoPagamento = new Date(alunos[alunoIndex].proximoPagamento + 'T12:00:00Z');
                            switch(alunos[alunoIndex].plano) {
                                case 'Mensal': proximoPagamento.setMonth(proximoPagamento.getMonth() + 1); break;
                                case 'Trimestral': proximoPagamento.setMonth(proximoPagamento.getMonth() + 3); break;
                                case 'Anual': proximoPagamento.setFullYear(proximoPagamento.getFullYear() + 1); break;
                            }
                            alunos[alunoIndex].proximoPagamento = proximoPagamento.toISOString().split('T')[0];
                            alunos[alunoIndex].status = 'Ativo';
                            localStorage.setItem('alunos', JSON.stringify(alunos));
                            showStudentDetailsModal(matricula);
                            loadStudentList();
                        }
                    }
                    if(action === 'save') {
                        let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
                        const alunoIndex = alunos.findIndex(a => a.matricula === matricula);
                        if(alunoIndex > -1) {
                            alunos[alunoIndex].nome = document.getElementById('edit-nome').value;
                            alunos[alunoIndex].plano = document.getElementById('edit-plano').value;
                            alunos[alunoIndex].proximoPagamento = document.getElementById('edit-vencimento').value;
                            alunos[alunoIndex].celular = document.getElementById('edit-celular').value;
                            alunos[alunoIndex].email = document.getElementById('edit-email').value;
                            alunos[alunoIndex].diasDeAula = Array.from(document.querySelectorAll('input[name="edit-diasAula"]:checked')).map(cb => cb.value);
                            alunos[alunoIndex].professor = document.getElementById('edit-professor').value;
                            alunos[alunoIndex].horarioAula = document.getElementById('edit-horarioAula').value;
                            const today = new Date(); today.setHours(0,0,0,0);
                            const newDueDate = new Date(alunos[alunoIndex].proximoPagamento + 'T12:00:00Z');
                            alunos[alunoIndex].status = newDueDate < today ? 'Inativo' : 'Ativo';
                            localStorage.setItem('alunos', JSON.stringify(alunos));
                            showStudentDetailsModal(matricula);
                            loadStudentList();
                        }
                    }
                }
                if(e.target.closest('.close-modal-btn') || e.target.classList.contains('modal-overlay')) {
                     document.getElementById('student-details-modal').classList.remove('active');
                }
            });
            document.body.addEventListener('change', (e) => {
                if(e.target.id === 'photo-input') {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('photo-preview').innerHTML = `<img src="${event.target.result}" alt="Foto do Aluno">`;
                            document.getElementById('remove-photo-btn').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
            document.body.addEventListener('input', (e) => {
                if(e.target.id === 'cpf') {
                    let v=e.target.value.replace(/\D/g,""); v=v.replace(/(\d{3})(\d)/,"$1.$2"); v=v.replace(/(\d{3})(\d)/,"$1.$2"); v=v.replace(/(\d{3})(\d{1,2})$/,"$1-$2"); e.target.value = v.slice(0,14);
                }
                if(e.target.id === 'celular') {
                    let v=e.target.value.replace(/\D/g,""); v=v.replace(/^(\d{2})(\d)/,"($1) $2"); v=v.replace(/(\d{5})(\d)/,"$1-$2"); e.target.value = v.slice(0,15);
                }
            });
        }
        function showFeedback(message, type, containerId) {
            const feedbackContainer = document.getElementById(containerId);
            feedbackContainer.innerHTML = message;
            feedbackContainer.className = `feedback-message ${type}`;
            feedbackContainer.classList.remove('hidden');
            setTimeout(() => { feedbackContainer.classList.add('hidden'); }, 8000);
        }
    </script>
</body>
</html>

