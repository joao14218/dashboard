<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanças - Arena Louzada</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root{--primary-color:#ffc400;--dark-bg:#1a1a1a;--dark-card:#2c2c2c;--text-light:#f0f0f0;--text-muted:#a0a0a0;--border-color:#444;--success-color:#28a745;--danger-color:#e74c3c;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{display:flex;background-color:var(--dark-bg);color:var(--text-light)}
        .app-layout{display:flex;width:100%;min-height:100vh}
        .sidebar{width:240px;background-color:var(--dark-card);padding:20px;display:flex;flex-direction:column;border-right:1px solid var(--border-color)}
        .sidebar-header{text-align:center;margin-bottom:40px}.sidebar-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);margin-bottom:10px}
        .sidebar-header h2{font-size:1.2rem;color:var(--text-light)}
        .nav-menu{flex-grow:1}.nav-menu a{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:8px;text-decoration:none;color:var(--text-muted);font-weight:600;transition:background-color .3s,color .3s}.nav-menu a i{font-size:1.5rem;margin-right:15px}.nav-menu a.active,.nav-menu a:hover{background-color:var(--primary-color);color:#000}

        .main-content{flex-grow:1;padding:40px;overflow-y:auto}
        
        .finance-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .summary-card{background-color:var(--dark-card);padding:25px;border-radius:10px;display:flex;align-items:center;gap:20px;border-left:5px solid var(--primary-color)}
        .summary-card.green{border-color:var(--success-color)}
        .summary-info h3{color:var(--text-muted);font-size:1rem;margin-bottom:5px}
        .summary-info p{font-size:1.8rem;font-weight:bold;color:var(--text-light)}

        .table-wrapper{background-color:var(--dark-card);padding:20px;border-radius:10px;overflow-x:auto;}
        .data-table{width:100%;border-collapse:collapse;text-align:left;}
        .data-table th,.data-table td{padding:15px;border-bottom:1px solid var(--border-color)}
        .data-table th{font-size:0.9rem;text-transform:uppercase;color:var(--text-muted)}
        .tag-receita{background-color:var(--success-color);padding:5px 10px;border-radius:15px;font-size:0.8rem;font-weight:bold;color:#fff;}
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        
        <main class="main-content">
            <h1 style="margin-bottom: 20px;">Histórico Financeiro</h1>
            
            <div class="finance-summary">
                <div class="summary-card green">
                    <div style="font-size:3rem; color:var(--success-color);"><i class="ph-fill ph-trend-up"></i></div>
                    <div class="summary-info">
                        <h3>Total de Receitas (Vendas)</h3>
                        <p id="total-receitas">Carregando...</p>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <h3 style="margin-bottom: 20px; color:var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom:10px;">Últimas Movimentações</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente / Descrição</th>
                            <th>Tipo</th>
                            <th>Valor (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-financas">
                        <tr><td colspan="4" style="text-align:center;">Buscando dados no servidor...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tabela = document.getElementById('tabela-financas');
            const totalEl = document.getElementById('total-receitas');
            
            try {
                const response = await fetch(`${window.API_URL}/vendas`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });

                if (response.ok) {
                    const vendas = await response.json();
                    tabela.innerHTML = '';
                    let total = 0;

                    if(vendas.length === 0) {
                        tabela.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhuma movimentação registrada.</td></tr>';
                        totalEl.textContent = 'R$ 0,00';
                        return;
                    }

                    // Ordena da mais recente para a mais antiga
                    vendas.reverse().forEach(venda => {
                        total += venda.total;
                        
                        // Formata a data de YYYY-MM-DD para DD/MM/YYYY
                        const dataFormatada = venda.data.split('-').reverse().join('/');

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dataFormatada}</td>
                            <td>${venda.cliente || 'Cliente Avulso'}</td>
                            <td><span class="tag-receita">Receita</span></td>
                            <td style="color:var(--success-color); font-weight:bold;">+ R$ ${venda.total.toFixed(2).replace('.', ',')}</td>
                        `;
                        tabela.appendChild(row);
                    });

                    totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                }
            } catch (error) {
                tabela.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Erro ao conectar com o servidor.</td></tr>';
            }
        });
    </script>
</body>
</html>
