<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - Arena Louzada</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root{--primary-color:#ffc400;--dark-bg:#1a1a1a;--dark-card:#2c2c2c;--text-light:#f0f0f0;--text-muted:#a0a0a0;--border-color:#444;--danger-color:#e74c3c;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{display:flex;background-color:var(--dark-bg);color:var(--text-light)}
        .app-layout{display:flex;width:100%;min-height:100vh}
        .sidebar{width:240px;background-color:var(--dark-card);padding:20px;display:flex;flex-direction:column;border-right:1px solid var(--border-color)}
        .sidebar-header{text-align:center;margin-bottom:40px}.sidebar-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);margin-bottom:10px}
        .sidebar-header h2{font-size:1.2rem;color:var(--text-light)}
        .nav-menu{flex-grow:1}.nav-menu a{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:8px;text-decoration:none;color:var(--text-muted);font-weight:600;transition:background-color .3s,color .3s}.nav-menu a i{font-size:1.5rem;margin-right:15px}.nav-menu a.active,.nav-menu a:hover{background-color:var(--primary-color);color:#000}

        .main-content{flex-grow:1;padding:40px;overflow-y:auto; display:flex; gap:30px; align-items:flex-start;}
        @media(max-width: 900px) { .main-content { flex-direction: column; } }

        .form-card{background-color:var(--dark-card);padding:30px;border-radius:10px; flex: 1; width: 100%;}
        .table-card{background-color:var(--dark-card);padding:30px;border-radius:10px; flex: 2; width: 100%; overflow-x: auto;}
        
        .form-group{margin-bottom:15px}
        .form-group label{display:block; margin-bottom:8px; font-weight:600;}
        .form-group input, .form-group select{width:100%;padding:12px;border-radius:8px;background-color:#3a3a3a;border:1px solid var(--border-color);color:var(--text-light);font-size:1rem}
        .submit-button{width:100%;padding:15px;border:none;border-radius:8px;background-color:var(--primary-color);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer; transition:0.2s;}

        .data-table{width:100%;border-collapse:collapse;text-align:left;}
        .data-table th,.data-table td{padding:15px;border-bottom:1px solid var(--border-color)}
        .data-table th{font-size:0.9rem;text-transform:uppercase;color:var(--text-muted)}
        .role-tag{padding:5px 10px;border-radius:15px;font-size:0.8rem;font-weight:bold;color:#fff; background:#555;}
        .role-ceo{background-color:var(--primary-color); color:#000;}
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        
        <main class="main-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Novo Usuário (Acesso Real)</h2>
                <form id="user-form">
                    <div class="form-group">
                        <label>Login (Nome de usuário)</label>
                        <input type="text" id="username" required placeholder="Ex: joao.prof">
                    </div>
                    <div class="form-group">
                        <label>Senha Provisória</label>
                        <input type="password" id="password" required placeholder="******">
                    </div>
                    <div class="form-group">
                        <label>Cargo / Permissão</label>
                        <select id="role" required>
                            <option value="Professor">Professor (Apenas Alunos e Aulas)</option>
                            <option value="Vendedor">Vendedor (Apenas PDV/Vendas)</option>
                            <option value="Administrador">Administrador (Acesso Total)</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-button" id="btn-salvar">Criar Acesso Oficial</button>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 15px; text-align:center;">Nota: O dono do banco de dados (admin CEO) não pode ser apagado.</p>
                </form>
            </div>

            <div class="table-card">
                <h2 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;"><i class="ph-fill ph-users-three"></i> Equipe no Servidor</h2>
                <table class="data-table">
                    <thead><tr><th>Usuário</th><th>Nível de Acesso</th><th>Ação</th></tr></thead>
                    <tbody id="users-list">
                        <tr><td colspan="3" style="text-align:center;">A carregar usuários do servidor...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            carregarUsuarios();

            document.getElementById('user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-salvar');
                btn.textContent = "Salvando na Nuvem..."; btn.disabled = true;

                const dados = {
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    role: document.getElementById('role').value
                };

                try {
                    const response = await fetch(`${window.API_URL}/usuarios`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionStorage.getItem('token')}` },
                        body: JSON.stringify(dados)
                    });

                    if (response.ok) {
                        alert("Usuário criado e salvo com sucesso no Servidor Python!");
                        e.target.reset();
                        carregarUsuarios();
                    } else {
                        const erro = await response.json();
                        alert("Erro: " + (erro.error || "Tente outro nome de usuário."));
                    }
                } catch (error) { alert("Erro de conexão."); } 
                finally { btn.textContent = "Criar Acesso Oficial"; btn.disabled = false; }
            });
        });

        async function carregarUsuarios() {
            const tbody = document.getElementById('users-list');
            try {
                const response = await fetch(`${window.API_URL}/usuarios`, { headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                if (response.ok) { 
                    const usuarios = await response.json(); 
                    tbody.innerHTML = '';
                    usuarios.forEach(u => {
                        const isCeo = u.role === 'CEO';
                        const tagClass = isCeo ? 'role-ceo' : '';
                        const btnHtml = isCeo ? '<span style="color:#888;">Bloqueado (Dono)</span>' : `<button onclick="apagarUsuario(${u.id})" style="background:var(--danger-color); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;"><i class="ph-bold ph-trash"></i></button>`;

                        tbody.innerHTML += `<tr>
                            <td><strong>${u.username}</strong></td>
                            <td><span class="role-tag ${tagClass}">${u.role}</span></td>
                            <td>${btnHtml}</td>
                        </tr>`;
                    });
                }
            } catch (error) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">Erro ao buscar usuários.</td></tr>'; }
        }

        window.apagarUsuario = async function(id) {
            if(confirm("Tem certeza? Esta pessoa não poderá mais acessar o sistema.")) {
                try {
                    await fetch(`${window.API_URL}/usuarios/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` } });
                    carregarUsuarios();
                } catch(e) { alert("Erro ao apagar."); }
            }
        }
    </script>
</body>
</html>
